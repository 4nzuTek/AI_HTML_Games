# FPSゲーム視点制御問題解決ノウハウ

## 📋 問題と原因

### 症状
- マウスでぐるぐる回すと視点が急に飛ぶ現象

### 誤った仮説
- ジンバルロック（数学的問題）
- Three.jsのバグ

### 真の原因
**ブラウザのPointer Lock API実装バグ**
```
⚠️ Extreme mouse movement detected: X=374, Y=335
🚨 CAMERA JUMP DETECTED! YawΔ=42.9°, PitchΔ=38.4°
```
- 正常：1-20ピクセル/フレーム
- 異常：200-400ピクセル/フレーム（断続的発生）

## 🛠️ 解決方法

### 多層フィルタリングシステム

```javascript
let lastValidMovement = { x: 0, y: 0, time: 0 };

function onMouseMove(e) {
    const movementX = e.movementX || 0;
    const movementY = e.movementY || 0;
    const now = performance.now();

    // フィルター1: 極端値除去
    if (Math.abs(movementX) > 100 || Math.abs(movementY) > 100) {
        return; // 異常値を完全無視
    }
    
    // フィルター2: 急激な加速度検出
    const timeDelta = now - lastValidMovement.time;
    if (timeDelta > 0 && timeDelta < 50) {
        const acceleration = Math.hypot(
            Math.abs(movementX - lastValidMovement.x),
            Math.abs(movementY - lastValidMovement.y)
        );
        if (acceleration > 150) return;
    }
    
    // 正常値のみ記録・適用
    lastValidMovement = { x: movementX, y: movementY, time: now };
    yaw -= movementX * MOUSE_SENSITIVITY;
    pitch -= movementY * MOUSE_SENSITIVITY;
    pitch = Math.max(-maxPitch, Math.min(maxPitch, pitch));
}
```

## 📚 失敗した対処法

1. **Minecraft式制御** → 入力値の異常は解決されず
2. **クォータニオン制御** → 数学的に正しいが異常入力で破綻
3. **複雑な角度正規化** → 根本原因に未対処

### なぜ失敗したか
- 症状（視点飛び）に注目し、原因（異常入力）を見落とし
- 数学的解決に固執し、入力品質を軽視

## ✅ 成功要因

1. **デバッグシステムによる可視化**
   - 入力値ログで異常を発見
   - 段階的な原因特定

2. **入力品質管理**
   - 入力段階でのフィルタリング
   - 異常値の完全除外

3. **根本原因への対処**
   - 症状ではなく原因を解決

## 🎯 開発ノウハウ

### 診断手順
1. **デバッグシステム構築** - 入力値・角度変化をログ出力
2. **原因特定** - 入力値確認（最重要）→計算過程→出力結果
3. **対処選択** - 入力フィルタリング（推奨）→数学的補正→設計変更

### 重要な教訓
- **入力品質が最重要** - 完璧な数学も異常入力で破綻
- **デバッグファースト** - 推測より実測で問題を可視化
- **ブラウザAPIの限界** - 異常値への対処は必須
- **シンプルな解決** - 複雑な解決より単純なフィルタリング

### 一般的な間違い
❌ 症状から解決方法を推測  
❌ 複雑な数学的解決を優先  
❌ デバッグ情報を軽視  

✅ 原因を特定してから対処  
✅ 入力品質の確保を最優先  
✅ 段階的なデバッグで問題を可視化  

---
*実際のバグ修正経験に基づく開発ノウハウ*
